<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M&amp;M's Sampling Distribution Simulator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Nunito', sans-serif;
    background: #3b1a08;
    background-image:
      radial-gradient(ellipse at 20% 50%, rgba(90,40,10,0.6) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 30%, rgba(70,30,5,0.5) 0%, transparent 50%),
      linear-gradient(180deg, #4a2010 0%, #2d1206 50%, #1a0a03 100%);
    min-height: 100vh; color: #f5e6d3;
  }
  .mm-btn {
    padding: 10px 20px; border: none; border-radius: 50px; cursor: pointer;
    font-family: 'Fredoka', sans-serif; font-size: 13px; font-weight: 600;
    transition: all 0.2s; letter-spacing: 0.3px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    box-shadow: 0 3px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
  }
  .mm-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2); }
  .mm-btn:active { transform: translateY(0); }
  .mm-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .panel {
    background: rgba(62,28,10,0.85); border: 2px solid rgba(139,90,43,0.4);
    border-radius: 20px; padding: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .bar-animate { transition: height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
  .flash { animation: flash 0.4s ease-out; }
  @keyframes flash { 0% { background: rgba(255,255,255,0.15); } 100% { background: rgba(62,28,10,0.85); } }
  .modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(26,10,3,0.85); backdrop-filter: blur(6px);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000; animation: fadeIn 0.2s ease-out;
  }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .modal-content {
    background: linear-gradient(135deg, #4a2010 0%, #2d1206 100%);
    border: 2px solid rgba(139,90,43,0.5); border-radius: 24px; padding: 28px;
    max-width: 700px; width: 90%;
    box-shadow: 0 8px 40px rgba(0,0,0,0.5); animation: slideUp 0.25s ease-out;
  }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .section-label { font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: 13px; color: #d4a574; letter-spacing: 1px; text-transform: uppercase; }
  .stat-value { font-family: 'Fredoka', sans-serif; font-weight: 700; }
  .ctrl-select { background: rgba(0,0,0,0.3); border: 2px solid rgba(139,90,43,0.4); border-radius: 10px; color: #f5e6d3; font-family: 'Fredoka', sans-serif; font-size: 13px; padding: 4px 8px; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useCallback, useRef, useEffect } = React;

const MM_TABS = [
  { key: "red",    label: "Red",    light: "#EF5350", dark: "#C62828", grad: "linear-gradient(145deg, #EF5350, #C62828)", text: "#fff", barGrad: "linear-gradient(180deg, #EF5350 0%, #C62828 100%)" },
  { key: "orange", label: "Orange", light: "#FFA726", dark: "#E65100", grad: "linear-gradient(145deg, #FFA726, #E65100)", text: "#fff", barGrad: "linear-gradient(180deg, #FFA726 0%, #E65100 100%)" },
  { key: "yellow", label: "Yellow", light: "#FFD54F", dark: "#F9A825", grad: "linear-gradient(145deg, #FFD54F, #F9A825)", text: "#5D4037", barGrad: "linear-gradient(180deg, #FFD54F 0%, #F9A825 100%)" },
  { key: "green",  label: "Green",  light: "#4CAF50", dark: "#2E7D32", grad: "linear-gradient(145deg, #4CAF50, #2E7D32)", text: "#fff", barGrad: "linear-gradient(180deg, #4CAF50 0%, #2E7D32 100%)" },
  { key: "blue",   label: "Blue",   light: "#42A5F5", dark: "#1565C0", grad: "linear-gradient(145deg, #42A5F5, #1565C0)", text: "#fff", barGrad: "linear-gradient(180deg, #42A5F5 0%, #1565C0 100%)" },
  { key: "brown",  label: "Brown",  light: "#8D6E63", dark: "#4E342E", grad: "linear-gradient(145deg, #8D6E63, #4E342E)", text: "#fff", barGrad: "linear-gradient(180deg, #8D6E63 0%, #4E342E 100%)" },
];

const CANDY_COLORS = MM_TABS.map(t => ({ bg: t.grad, text: t.text }));
const DEFAULT_BY_COLOR = {
  red:    [2,0,1,1,7,1,2,1,4,0,1,2,2,2,2,4,2,1,1,1,2,3,2,4,0],
  orange: [8,8,4,6,3,2,2,5,7,6,6,1,3,5,4,4,0,6,4,6,4,2,1,4,8],
  yellow: [1,1,1,1,1,2,1,2,1,3,1,2,3,0,2,2,3,2,1,1,2,1,0,1,0],
  green:  [2,0,1,0,1,1,3,2,1,1,3,1,2,1,2,0,1,1,2,1,2,2,1,1,4],
  blue:   [2,6,6,5,4,6,5,2,1,3,4,6,5,6,4,4,8,5,3,4,2,2,7,5,2],
  brown:  [0,0,1,1,5,5,2,3,1,3,1,4,1,1,1,3,0,2,3,3,2,4,3,0,1],
};
const DEFAULT_DATA = DEFAULT_BY_COLOR.green;

function matchColorHeader(header) {
  const h = header.toLowerCase().trim();
  for (const color of ["red","orange","yellow","green","blue","brown"]) {
    if (h.includes(color)) return color;
  }
  return null;
}

function parsePastedTable(text) {
  // Split into rows, detect tab or comma separation
  const rows = text.trim().split(/\r?\n/).filter(r => r.trim());
  if (rows.length < 2) return null;

  const delim = rows[0].includes("\t") ? "\t" : ",";
  const headers = rows[0].split(delim).map(h => h.trim());
  const colorMap = {};
  const colIndices = {};

  headers.forEach((h, i) => {
    const color = matchColorHeader(h);
    if (color && !colIndices[color]) {
      colIndices[color] = i;
      colorMap[color] = [];
    }
  });

  if (Object.keys(colIndices).length === 0) return null;

  for (let r = 1; r < rows.length; r++) {
    const cells = rows[r].split(delim);
    Object.entries(colIndices).forEach(([color, idx]) => {
      const val = Number(cells[idx]);
      if (!isNaN(val) && val >= 0) colorMap[color].push(val);
    });
  }

  // Filter out colors with no data
  const result = {};
  Object.entries(colorMap).forEach(([k, v]) => { if (v.length > 0) result[k] = v; });
  return Object.keys(result).length > 0 ? result : null;
}

function parseDataInput(text) {
  return text.split(/[\s,;\t\n\r]+/).map(s => s.trim()).filter(Boolean).map(Number).filter(n => !isNaN(n) && n >= 0);
}

function generateBins(min, max, step) {
  const bins = [];
  for (let v = min; v <= max; v = Math.round((v + step) * 10) / 10) bins.push(v);
  return bins;
}

function MmCandy({ value, size, highlighted, colorIndex, theme }) {
  const color = highlighted ? { bg: theme.grad, text: theme.text } : CANDY_COLORS[colorIndex % CANDY_COLORS.length];
  const dim = size || 32;
  return (
    <div style={{
      display: "inline-flex", alignItems: "center", justifyContent: "center",
      width: dim, height: dim, borderRadius: "50%", background: color.bg, color: color.text,
      fontSize: dim * 0.42, fontFamily: "'Fredoka', sans-serif", fontWeight: 700,
      border: highlighted ? "2px solid " + theme.light + "88" : "1px solid rgba(0,0,0,0.2)",
      boxShadow: "0 3px 6px rgba(0,0,0,0.35), inset 0 -3px 6px rgba(0,0,0,0.2), inset 0 3px 6px rgba(255,255,255,0.15)",
      transform: highlighted ? "scale(1.1)" : "scale(1)", transition: "all 0.3s",
      position: "relative", overflow: "hidden", textShadow: "0 1px 2px rgba(0,0,0,0.3)", flexShrink: 0,
    }}>
      <div style={{ position: "absolute", top: "12%", left: "18%", width: "35%", height: "22%",
        background: "radial-gradient(ellipse, rgba(255,255,255,0.4) 0%, transparent 70%)",
        borderRadius: "50%", transform: "rotate(-30deg)", pointerEvents: "none" }} />
      <span style={{ position: "relative", zIndex: 1 }}>{value}</span>
    </div>
  );
}

function PopulationModal({ rawData, onClose, theme }) {
  const popMean = rawData.reduce((a, b) => a + b, 0) / rawData.length;
  const popSD = Math.sqrt(rawData.reduce((s, v) => s + (v - popMean) ** 2, 0) / rawData.length);
  const min = Math.min(...rawData); const max = Math.max(...rawData);
  const freq = {}; rawData.forEach(v => { freq[v] = (freq[v] || 0) + 1; });
  const allVals = []; for (let v = min; v <= max; v++) allVals.push(v);
  const maxFreq = Math.max(...allVals.map(v => freq[v] || 0));
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" style={{ borderColor: theme.light + "55" }} onClick={e => e.stopPropagation()}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
          <h2 style={{ fontFamily: "'Fredoka', sans-serif", fontSize: 22, fontWeight: 700, color: theme.light, margin: 0 }}>{theme.label} M&amp;M's — Population</h2>
          <button className="mm-btn" style={{ padding: "6px 18px", fontSize: 12, background: theme.grad, color: theme.text }} onClick={onClose}>Close</button>
        </div>
        <p style={{ fontSize: 13, color: "#d4a574", marginBottom: 16 }}>The "population" is the entire class's {rawData.length} bags.</p>
        <div style={{ display: "flex", alignItems: "flex-end", gap: 8, height: 180, marginBottom: 8, paddingBottom: 28 }}>
          {allVals.map((v) => {
            const count = freq[v] || 0;
            return (
              <div key={v} style={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", height: "100%", justifyContent: "flex-end" }}>
                <div style={{ fontSize: 12, color: "#f5e6d3", marginBottom: 3, fontWeight: 700, fontFamily: "'Fredoka'" }}>{count > 0 ? count : ""}</div>
                <div style={{ width: "65%", height: maxFreq > 0 ? (count / maxFreq) * 130 + "px" : "0px", background: theme.barGrad, borderRadius: "12px 12px 4px 4px", boxShadow: count > 0 ? "0 3px 10px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.15)" : "none", minHeight: count > 0 ? 4 : 0 }} />
                <div style={{ fontSize: 14, color: theme.light, marginTop: 6, fontWeight: 700, fontFamily: "'Fredoka'" }}>{v}</div>
              </div>
            );
          })}
        </div>
        <div style={{ textAlign: "center", fontSize: 11, color: "#a0826d", letterSpacing: 1, marginBottom: 20, fontFamily: "'Fredoka'" }}>{theme.label.toUpperCase()} M&amp;M's PER BAG</div>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 12, padding: "14px 0", borderTop: "2px solid rgba(139,90,43,0.3)" }}>
          {[{ label: "N (bags)", value: rawData.length }, { label: "Pop. Mean (\u03BC)", value: popMean.toFixed(3) }, { label: "Pop. SD (\u03C3)", value: popSD.toFixed(3) }, { label: "Range", value: min + " \u2013 " + max }].map((stat, i) => (
            <div key={i} style={{ textAlign: "center" }}>
              <div style={{ fontSize: 10, color: "#a0826d", letterSpacing: 0.5, marginBottom: 4, textTransform: "uppercase", fontFamily: "'Fredoka'" }}>{stat.label}</div>
              <div className="stat-value" style={{ fontSize: 18, color: theme.light }}>{stat.value}</div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

/* ─── Data Import Tab ─── */
function DataTab({ onImport, tabStates }) {
  const [pasteText, setPasteText] = useState("");
  const [preview, setPreview] = useState(null);
  const [imported, setImported] = useState(false);

  const handlePaste = (text) => {
    setPasteText(text);
    setImported(false);
    const parsed = parsePastedTable(text);
    setPreview(parsed);
  };

  const handleImport = () => {
    if (preview) {
      onImport(preview);
      setImported(true);
    }
  };

  return (
    <div style={{ maxWidth: 800, margin: "0 auto" }}>
      <div className="panel" style={{ marginBottom: 16 }}>
        <div className="section-label" style={{ marginBottom: 12 }}>Paste Class Data</div>
        <div style={{ fontFamily: "'Fredoka'", fontSize: 13, color: "#d4a574", marginBottom: 14, lineHeight: 1.7 }}>
          <p><strong>How to use:</strong></p>
          <p>1. Open your Google Sheet with the class M&amp;M data</p>
          <p>2. Select all the data <strong>including the header row</strong> (the row with color names)</p>
          <p>3. Copy it (Ctrl+C / Cmd+C)</p>
          <p>4. Click in the box below and paste (Ctrl+V / Cmd+V)</p>
          <p style={{ marginTop: 8, color: "#a0826d", fontSize: 11 }}>
            The headers should contain color names (Red, Orange, Yellow, Green, Blue, Brown).
            Other columns (like student names or totals) will be ignored automatically.
          </p>
        </div>
        <textarea
          value={pasteText}
          onChange={e => handlePaste(e.target.value)}
          onPaste={e => { setTimeout(() => handlePaste(e.target.value), 0); }}
          style={{
            width: "100%", height: 200, background: "rgba(0,0,0,0.3)",
            border: "2px solid rgba(139,90,43,0.4)", borderRadius: 12,
            color: "#f5e6d3", fontFamily: "'Nunito', monospace", fontSize: 13,
            padding: 12, resize: "vertical", lineHeight: 1.5,
          }}
          placeholder={"Name\tRed\tOrange\tYellow\tGreen\tBlue\tBrown\nAlice\t4\t3\t2\t5\t6\t3\nBob\t6\t5\t3\t4\t5\t4\n..."}
        />
      </div>

      {/* Preview */}
      {preview && (
        <div className="panel" style={{ marginBottom: 16 }}>
          <div className="section-label" style={{ marginBottom: 12 }}>
            Preview — {Object.keys(preview).length} color{Object.keys(preview).length !== 1 ? "s" : ""} detected
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(140px, 1fr))", gap: 10 }}>
            {MM_TABS.map(t => {
              const data = preview[t.key];
              if (!data) return (
                <div key={t.key} style={{ padding: 10, borderRadius: 12, background: "rgba(0,0,0,0.2)", border: "1px solid rgba(139,90,43,0.2)", opacity: 0.4 }}>
                  <div style={{ fontFamily: "'Fredoka'", fontSize: 12, color: "#7a5a3a", fontWeight: 700, marginBottom: 4 }}>{t.label}</div>
                  <div style={{ fontSize: 11, color: "#7a5a3a" }}>No column found</div>
                </div>
              );
              const mean = (data.reduce((a, b) => a + b, 0) / data.length).toFixed(2);
              return (
                <div key={t.key} style={{ padding: 10, borderRadius: 12, background: t.dark + "33", border: "1px solid " + t.light + "44" }}>
                  <div style={{ fontFamily: "'Fredoka'", fontSize: 12, color: t.light, fontWeight: 700, marginBottom: 4 }}>{t.label}</div>
                  <div style={{ fontSize: 11, color: "#d4a574" }}>{data.length} values</div>
                  <div style={{ fontSize: 11, color: "#d4a574" }}>{"\u03BC"} = {mean}</div>
                  <div style={{ display: "flex", flexWrap: "wrap", gap: 3, marginTop: 6 }}>
                    {data.slice(0, 12).map((v, i) => (
                      <span key={i} style={{
                        display: "inline-block", background: t.grad,
                        color: t.text, borderRadius: "50%", width: 22, height: 22,
                        fontSize: 10, fontWeight: 700, fontFamily: "'Fredoka'",
                        textAlign: "center", lineHeight: "22px",
                        boxShadow: "0 1px 3px rgba(0,0,0,0.3), inset 0 1px 2px rgba(255,255,255,0.15)",
                      }}>{v}</span>
                    ))}
                    {data.length > 12 && <span style={{ fontSize: 10, color: "#a0826d", lineHeight: "22px" }}>+{data.length - 12}</span>}
                  </div>
                </div>
              );
            })}
          </div>

          <button className="mm-btn" disabled={!preview} onClick={handleImport} style={{
            width: "100%", marginTop: 14, padding: "12px 20px", fontSize: 15,
            background: imported
              ? "linear-gradient(180deg, #4CAF50 0%, #2E7D32 100%)"
              : "linear-gradient(180deg, #FFD54F 0%, #F9A825 100%)",
            color: imported ? "#fff" : "#5D4037",
          }}>
            {imported ? "\u2714 Data Loaded! Switch to a color tab to start sampling." : "Load Data Into Simulator"}
          </button>
        </div>
      )}

      {/* Current data status */}
      <div className="panel">
        <div className="section-label" style={{ marginBottom: 10 }}>Current Data Status</div>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(6, 1fr)", gap: 8 }}>
          {MM_TABS.map(t => {
            const data = tabStates[t.key].rawData;
            const isDefault = JSON.stringify(data) === JSON.stringify(DEFAULT_BY_COLOR[t.key]);
            return (
              <div key={t.key} style={{ textAlign: "center", padding: 8, borderRadius: 10, background: t.dark + "22" }}>
                <div style={{
                  width: 28, height: 28, borderRadius: "50%", background: t.grad,
                  margin: "0 auto 6px", boxShadow: "0 2px 4px rgba(0,0,0,0.3), inset 0 1px 3px rgba(255,255,255,0.15)",
                }} />
                <div style={{ fontFamily: "'Fredoka'", fontSize: 11, color: t.light, fontWeight: 700 }}>{t.label}</div>
                <div style={{ fontSize: 10, color: "#4CAF50", fontFamily: "'Fredoka'", marginTop: 2 }}>
                  {data.length + " values"}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

/* ─── Simulation Tab ─── */
function ColorTab({ tabData, onUpdate, theme, sampleSize, binStep }) {
  const { rawData, sampleMeans, currentSample, editingData, dataInput } = tabData;
  const [isAnimating, setIsAnimating] = useState(false);
  const [autoRunning, setAutoRunning] = useState(false);
  const [showPopulation, setShowPopulation] = useState(false);
  const autoRef = useRef(false);
  const animFrameRef = useRef(null);
  const meansRef = useRef(sampleMeans);

  useEffect(() => { meansRef.current = sampleMeans; }, [sampleMeans]);
  useEffect(() => { return () => { autoRef.current = false; if (animFrameRef.current) clearTimeout(animFrameRef.current); }; }, []);

  const drawOneSample = useCallback(() => {
    const drawn = [];
    for (let i = 0; i < sampleSize; i++) {
      const idx = Math.floor(Math.random() * rawData.length);
      drawn.push({ personIndex: idx, value: rawData[idx] });
    }
    const mean = drawn.reduce((s, d) => s + d.value, 0) / drawn.length;
    return { drawn, mean: Math.round(mean * 100) / 100 };
  }, [rawData, sampleSize]);

  const handleDraw = useCallback(() => {
    const r = drawOneSample();
    onUpdate({ currentSample: r, sampleMeans: [...meansRef.current, r.mean] });
    setIsAnimating(true); setTimeout(() => setIsAnimating(false), 400);
  }, [drawOneSample, onUpdate]);

  const handleDrawN = useCallback((n) => {
    const newMeans = []; let last = null;
    for (let i = 0; i < n; i++) { const r = drawOneSample(); newMeans.push(r.mean); last = r; }
    onUpdate({ currentSample: last, sampleMeans: [...meansRef.current, ...newMeans] });
    setIsAnimating(true); setTimeout(() => setIsAnimating(false), 400);
  }, [drawOneSample, onUpdate]);

  const handleReset = () => { onUpdate({ sampleMeans: [], currentSample: null }); setAutoRunning(false); autoRef.current = false; };

  const toggleAutoRun = useCallback(() => {
    if (autoRunning) { setAutoRunning(false); autoRef.current = false; return; }
    setAutoRunning(true); autoRef.current = true;
    const run = () => {
      if (!autoRef.current) return;
      const r = drawOneSample();
      const updated = [...meansRef.current, r.mean];
      meansRef.current = updated;
      onUpdate({ currentSample: r, sampleMeans: updated });
      animFrameRef.current = setTimeout(run, 80);
    };
    run();
  }, [autoRunning, drawOneSample, onUpdate]);

  const handleSaveData = () => {
    const vals = parseDataInput(dataInput);
    if (vals.length > 0) onUpdate({ rawData: vals, sampleMeans: [], currentSample: null, editingData: false });
  };

  const popMean = rawData.reduce((a, b) => a + b, 0) / rawData.length;
  const popSD = Math.sqrt(rawData.reduce((s, v) => s + (v - popMean) ** 2, 0) / rawData.length);
  const bins = generateBins(Math.max(0, Math.floor(Math.min(...rawData)) - 0.5), Math.ceil(Math.max(...rawData)) + 0.5, binStep);
  const histogram = bins.map((edge, i) => {
    const low = i === 0 ? -Infinity : bins[i - 1];
    return { label: edge.toFixed(1), count: sampleMeans.filter(m => m > low && m <= edge).length };
  }).filter((_, i) => i > 0);
  const maxCount = Math.max(1, ...histogram.map(b => b.count));
  const grandMean = sampleMeans.length > 0 ? (sampleMeans.reduce((a, b) => a + b, 0) / sampleMeans.length).toFixed(3) : "\u2014";
  const stdErr = sampleMeans.length > 1 ? Math.sqrt(sampleMeans.reduce((s, m) => s + (m - parseFloat(grandMean)) ** 2, 0) / (sampleMeans.length - 1)).toFixed(3) : "\u2014";
  const theoreticalSE = (popSD / Math.sqrt(sampleSize)).toFixed(3);

  const btnStyle = { background: theme.barGrad, color: theme.text };
  const btnYellow = { background: "linear-gradient(180deg, #FFD54F 0%, #F9A825 100%)", color: "#5D4037" };
  const btnRed = { background: "linear-gradient(180deg, #EF5350 0%, #C62828 100%)", color: "#fff" };
  const btnBrown = { background: "linear-gradient(180deg, #8D6E63 0%, #4E342E 100%)", color: "#fff" };

  return (
    <div>
      {showPopulation && <PopulationModal rawData={rawData} onClose={() => setShowPopulation(false)} theme={theme} />}
      <div style={{ display: "grid", gridTemplateColumns: "270px 1fr", gap: 16 }}>
        <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
          <div className="panel">
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
              <span className="section-label">{theme.label} Data ({rawData.length} bags)</span>
              <div style={{ display: "flex", gap: 6 }}>
                <button className="mm-btn" style={{ padding: "4px 14px", fontSize: 11, ...btnStyle }} onClick={() => setShowPopulation(true)}>Population</button>
                <button className="mm-btn" style={{ padding: "4px 14px", fontSize: 11, ...btnBrown }}
                  onClick={() => onUpdate({ editingData: !editingData, dataInput: rawData.join("\n") })}>{editingData ? "Cancel" : "Edit"}</button>
              </div>
            </div>
            {editingData ? (
              <div>
                <textarea value={dataInput} onChange={e => onUpdate({ dataInput: e.target.value })}
                  style={{ width: "100%", height: 160, background: "rgba(0,0,0,0.3)", border: "2px solid rgba(139,90,43,0.4)", borderRadius: 12, color: "#f5e6d3", fontFamily: "'Nunito', sans-serif", fontSize: 13, padding: 10, resize: "vertical" }}
                  placeholder={"Paste one value per line, comma-separated, or from a spreadsheet column..."} />
                <div style={{ fontSize: 11, color: "#a0826d", margin: "4px 0 6px" }}>Accepts any format: one per line, commas, tabs, or pasted from Excel.</div>
                <button className="mm-btn" style={{ width: "100%", fontSize: 12, ...btnStyle }} onClick={handleSaveData}>Save Data ({parseDataInput(dataInput).length} values found)</button>
              </div>
            ) : (
              <div style={{ display: "flex", flexWrap: "wrap", gap: 5, justifyContent: "center" }}>
                {rawData.map((v, i) => (
                  <MmCandy key={i} value={v} size={32} colorIndex={i} theme={theme}
                    highlighted={currentSample ? currentSample.drawn.some(d => d.personIndex === i) : false} />
                ))}
              </div>
            )}
            {!editingData && (
              <div style={{ marginTop: 10, fontSize: 12, color: "#a0826d", textAlign: "center", fontFamily: "'Fredoka'" }}>
                {"\u03BC"} = <span style={{ color: theme.light, fontWeight: 700 }}>{popMean.toFixed(2)}</span>
                {" \u00b7 "}{"\u03C3"} = <span style={{ color: theme.light, fontWeight: 700 }}>{popSD.toFixed(2)}</span>
              </div>
            )}
          </div>
          <div className={"panel " + (isAnimating ? "flash" : "")} style={{ height: 140, display: "flex", flexDirection: "column" }}>
            <div className="section-label" style={{ marginBottom: 8, flexShrink: 0 }}>Current Sample</div>
            {currentSample ? (
              <div style={{ display: "flex", flexDirection: "column", minHeight: 0, flex: 1 }}>
                <div style={{ display: "flex", gap: 6, justifyContent: "center", flexWrap: "wrap", overflowY: "auto", flex: 1, alignContent: "center", padding: "2px 0" }}>
                  {currentSample.drawn.map((d, i) => (
                    <MmCandy key={i} value={d.value} size={40} colorIndex={MM_TABS.findIndex(t => t.key === theme.key)} theme={theme} highlighted={true} />
                  ))}
                </div>
                <div style={{ textAlign: "center", fontSize: 15, color: theme.light, fontFamily: "'Fredoka'", fontWeight: 700, flexShrink: 0, paddingTop: 4 }}>x&#772; = {currentSample.mean.toFixed(2)}</div>
              </div>
            ) : (
              <div style={{ textAlign: "center", color: "#7a5a3a", fontSize: 13, padding: "14px 0", fontFamily: "'Fredoka'", flex: 1, display: "flex", alignItems: "center", justifyContent: "center" }}>Click "Draw" to grab some M&amp;M's!</div>
            )}
          </div>
          <div className="panel" style={{ display: "flex", flexDirection: "column", gap: 8 }}>
            <button className="mm-btn" style={btnStyle} onClick={handleDraw}>Draw 1 Sample</button>
            <button className="mm-btn" style={btnStyle} onClick={() => handleDrawN(10)}>Draw 10 Samples</button>
            <button className="mm-btn" style={btnStyle} onClick={() => handleDrawN(100)}>Draw 100 Samples</button>
            <button className="mm-btn" style={btnYellow} onClick={toggleAutoRun}>{autoRunning ? "\u23F8 Stop Auto-Draw" : "\u25B6 Auto-Draw"}</button>
            <button className="mm-btn" style={btnRed} onClick={handleReset}>Reset</button>
          </div>
        </div>
        <div style={{ display: "flex", flexDirection: "column", gap: 0 }}>
          <div className="panel" style={{ borderRadius: "20px", paddingBottom: 10 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "baseline", marginBottom: 8 }}>
              <span className="section-label">Sampling Distribution</span>
              <span style={{ fontSize: 12, color: "#a0826d", fontFamily: "'Fredoka'" }}>{sampleMeans.length} sample{sampleMeans.length !== 1 ? "s" : ""} drawn</span>
            </div>
            <div style={{ position: "relative", height: 240, display: "flex", alignItems: "flex-end", gap: 1, paddingBottom: 28 }}>
              <div style={{ position: "absolute", left: -6, top: "40%", transform: "rotate(-90deg)", fontSize: 10, color: "#a0826d", letterSpacing: 1, fontFamily: "'Fredoka'" }}>FREQ</div>
              {histogram.map((bin, i) => {
                const barH = maxCount > 0 ? (bin.count / maxCount) * 200 : 0;
                const showLabel = histogram.length <= 20 || i % Math.ceil(histogram.length / 20) === 0;
                return (
                  <div key={i} style={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", height: "100%", justifyContent: "flex-end", minWidth: 0 }}>
                    <div style={{ fontSize: histogram.length > 30 ? 8 : 10, color: "#d4a574", marginBottom: 2, fontFamily: "'Fredoka'", fontWeight: 600 }}>{bin.count > 0 && histogram.length <= 40 ? bin.count : ""}</div>
                    <div className="bar-animate" style={{
                      width: "90%", height: barH + "px", background: theme.barGrad,
                      borderRadius: histogram.length > 30 ? "3px 3px 1px 1px" : "10px 10px 3px 3px",
                      boxShadow: bin.count > 0 ? "0 2px 6px " + theme.dark + "44, inset 0 1px 3px rgba(255,255,255,0.15)" : "none",
                      minHeight: bin.count > 0 ? 2 : 0,
                    }} />
                    {showLabel && (<div style={{ fontSize: histogram.length > 30 ? 7 : 9, color: "#a0826d", marginTop: 3, position: "absolute", bottom: 0, transform: "rotate(-45deg)", transformOrigin: "top center", whiteSpace: "nowrap", fontFamily: "'Fredoka'" }}>{bin.label}</div>)}
                  </div>
                );
              })}
            </div>
            <div style={{ textAlign: "center", fontSize: 11, color: "#a0826d", marginTop: 4, marginBottom: 6, letterSpacing: 1, fontFamily: "'Fredoka'" }}>SAMPLE MEAN ({theme.label.toUpperCase()} M&amp;M's)</div>

            {/* Stats row — inside the same panel */}
            <div style={{ borderTop: "2px solid rgba(139,90,43,0.25)", paddingTop: 8 }}>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 8 }}>
                {[
                  { label: "Samples Drawn", value: sampleMeans.length, color: "#42A5F5" },
                  { label: "Mean of x\u0304's", value: grandMean, color: theme.light },
                  { label: "SE (observed)", value: stdErr, color: "#FFA726" },
                  { label: "SE (\u03C3/\u221An)", value: theoreticalSE, color: "#EF5350" },
                ].map((stat, i) => (
                  <div key={i} style={{ textAlign: "center" }}>
                    <div style={{ fontSize: 10, color: "#a0826d", letterSpacing: 0.5, marginBottom: 3, textTransform: "uppercase", fontFamily: "'Fredoka'" }}>{stat.label}</div>
                    <div className="stat-value" style={{ fontSize: 20, color: stat.color }}>{stat.value}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ─── App ─── */
function App() {
  const [activeTab, setActiveTab] = useState("data");
  const [sampleSize, setSampleSize] = useState(5);
  const [binStep, setBinStep] = useState(0.25);

  const makeDefault = (colorKey) => {
    const data = DEFAULT_BY_COLOR[colorKey] || DEFAULT_DATA;
    return {
      rawData: [...data], sampleMeans: [], currentSample: null,
      editingData: false, dataInput: data.join("\n"),
    };
  };

  const [tabStates, setTabStates] = useState(() => {
    const s = {};
    MM_TABS.forEach(t => { s[t.key] = makeDefault(t.key); });
    return s;
  });

  const handleTabUpdate = useCallback((key, partial) => {
    setTabStates(prev => ({ ...prev, [key]: { ...prev[key], ...partial } }));
  }, []);

  const handleSampleSizeChange = (n) => {
    setSampleSize(n);
    setTabStates(prev => {
      const next = {};
      Object.keys(prev).forEach(k => { next[k] = { ...prev[k], sampleMeans: [], currentSample: null }; });
      return next;
    });
  };

  const handleSheetImport = (colorData) => {
    setTabStates(prev => {
      const next = { ...prev };
      Object.entries(colorData).forEach(([colorKey, values]) => {
        next[colorKey] = { rawData: values, sampleMeans: [], currentSample: null, editingData: false, dataInput: values.join("\n") };
      });
      return next;
    });
  };

  const theme = MM_TABS.find(t => t.key === activeTab);
  const isDataTab = activeTab === "data";

  return (
    <div style={{ padding: 20, maxWidth: 1100, margin: "0 auto" }}>
      <div style={{ textAlign: "center", marginBottom: 20 }}>
        <div style={{ display: "inline-flex", alignItems: "center", gap: 6, marginBottom: 8 }}>
          {MM_TABS.map(t => (
            <div key={t.key} style={{ width: 18, height: 18, borderRadius: "50%", background: t.grad,
              boxShadow: "0 2px 4px rgba(0,0,0,0.35), inset 0 -2px 4px rgba(0,0,0,0.2), inset 0 2px 4px rgba(255,255,255,0.2)" }} />
          ))}
        </div>
        <h1 style={{ fontFamily: "'Fredoka'", fontSize: 28, fontWeight: 700, color: "#FFD54F", margin: 0,
          textShadow: "0 2px 8px rgba(0,0,0,0.4), 0 0 30px rgba(255,213,79,0.15)" }}>
          M&amp;M's Sampling Distribution
        </h1>
        <p style={{ color: "#a0826d", fontSize: 13, margin: "6px 0 0", fontFamily: "'Fredoka'" }}>
          {isDataTab ? "Paste your class data below to get started" : "Draw random samples of n=" + sampleSize + " with replacement"}
        </p>
      </div>

      {/* Tab bar */}
      <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6, marginBottom: 16, flexWrap: "wrap" }}>
        {/* Data tab */}
        <button onClick={() => setActiveTab("data")} style={{
          padding: "8px 18px", borderRadius: 50, border: "none", cursor: "pointer",
          fontFamily: "'Fredoka'", fontSize: 14, fontWeight: 700,
          background: isDataTab ? "linear-gradient(180deg, #FFD54F 0%, #F9A825 100%)" : "rgba(62,28,10,0.7)",
          color: isDataTab ? "#5D4037" : "#8a6a50",
          boxShadow: isDataTab ? "0 4px 12px rgba(249,168,37,0.4), inset 0 1px 0 rgba(255,255,255,0.2)" : "0 2px 6px rgba(0,0,0,0.2)",
          transform: isDataTab ? "scale(1.05)" : "scale(1)", transition: "all 0.2s",
        }}>
          {"\uD83D\uDCCB"} Data
        </button>

        <div style={{ width: 1, height: 24, background: "rgba(139,90,43,0.3)", margin: "0 4px" }} />

        {MM_TABS.map(t => {
          const isActive = activeTab === t.key;
          const count = tabStates[t.key].sampleMeans.length;
          const isDefault = JSON.stringify(tabStates[t.key].rawData) === JSON.stringify(DEFAULT_BY_COLOR[t.key]);
          return (
            <button key={t.key} onClick={() => setActiveTab(t.key)} style={{
              padding: "8px 18px", borderRadius: 50, border: "none", cursor: "pointer",
              fontFamily: "'Fredoka'", fontSize: 14, fontWeight: 700,
              background: isActive ? t.barGrad : "rgba(62,28,10,0.7)",
              color: isActive ? t.text : "#8a6a50",
              boxShadow: isActive ? "0 4px 12px " + t.dark + "66, inset 0 1px 0 rgba(255,255,255,0.2)" : "0 2px 6px rgba(0,0,0,0.2)",
              transform: isActive ? "scale(1.05)" : "scale(1)", transition: "all 0.2s", position: "relative",
            }}>
              {t.label}
              {count > 0 && (
                <span style={{
                  position: "absolute", top: -6, right: -6,
                  background: "#FFD54F", color: "#5D4037",
                  fontSize: 9, fontWeight: 700, borderRadius: 50,
                  padding: "1px 5px", minWidth: 18, textAlign: "center",
                  boxShadow: "0 1px 3px rgba(0,0,0,0.3)",
                }}>{count}</span>
              )}
            </button>
          );
        })}

        {!isDataTab && (
          <>
            <div style={{ marginLeft: 12, display: "flex", alignItems: "center", gap: 6 }}>
              <label style={{ fontSize: 12, color: "#a0826d", fontFamily: "'Fredoka'" }}>n =</label>
              <select className="ctrl-select" value={sampleSize} onChange={e => handleSampleSizeChange(Number(e.target.value))}>
                {[2,3,5,10,15,20,30,50,100].map(n => <option key={n} value={n}>{n}</option>)}
              </select>
            </div>
            <div style={{ marginLeft: 8, display: "flex", alignItems: "center", gap: 6 }}>
              <label style={{ fontSize: 12, color: "#a0826d", fontFamily: "'Fredoka'" }}>Bin =</label>
              <select className="ctrl-select" value={binStep} onChange={e => setBinStep(Number(e.target.value))}>
                {[0.1, 0.2, 0.25, 0.5, 1.0].map(w => <option key={w} value={w}>{w}</option>)}
              </select>
            </div>
          </>
        )}
      </div>

      {/* Content */}
      {isDataTab ? (
        <DataTab onImport={handleSheetImport} tabStates={tabStates} />
      ) : (
        <ColorTab
          key={activeTab}
          tabData={tabStates[activeTab]}
          onUpdate={(partial) => handleTabUpdate(activeTab, partial)}
          theme={theme}
          sampleSize={sampleSize}
          binStep={binStep}
        />
      )}
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
